<html>
    <head>
        <title> VSA </title>
    </head>
    <body>
        <div class="svg-container"><svg></svg></div>
        <div class="vsa" id="root">
            
                <div class="union">
                    <div class="box">
                        <span class="op">∪</span>
                        <div class="union-label">StringConst("First Last") → StringConst("F.L.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F.L.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="union">
                    <div class="box">
                        <span class="op">∪</span>
                        <div class="union-label">StringConst("First Last") → StringConst("F")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657238243872'><span class="lit">0</span></div> <div class="leaf box" id='94657238248800'><span class="lit">1</span></div>
                    </div>
                </div>
                
                    </div>
                </div> 
                <div class="union">
                    <div class="box">
                        <span class="op">∪</span>
                        <div class="union-label">StringConst("First Last") → StringConst(".L.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst(".L.")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657238249264'><span class="lit">'.'</span></div> 
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("L.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("L")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657238249232'><span class="lit">X.find_end(' ', 0)</span></div> <div class="leaf box" id='94657238238912'><span class="lit">X.find_end('[A-Z]', 1)</span></div>
                    </div>
                </div>
                 <div class="leaf box" id='94657238247584'><span class="lit">'.'</span></div>
                    </div>
                </div>
                
                    </div>
                </div>
                  
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst(".L.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst(".L")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657238172272'><span class="lit">'.'</span></div> 
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("L")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657237457248'><span class="lit">X.find_end(' ', 0)</span></div> <div class="leaf box" id='94657238012736'><span class="lit">X.find_end('[A-Z]', 1)</span></div>
                    </div>
                </div>
                
                    </div>
                </div>
                 <div class="leaf box" id='94657237927792'><span class="lit">'.'</span></div>
                    </div>
                </div>
                
                    </div>
                </div>
                    </div>
                </div>
                    
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F.L.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="union">
                    <div class="box">
                        <span class="op">∪</span>
                        <div class="union-label">StringConst("First Last") → StringConst("F")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657237924336'><span class="lit">0</span></div> <div class="leaf box" id='94657237906512'><span class="lit">1</span></div>
                    </div>
                </div>
                
                    </div>
                </div> <div class="leaf box" id='94657237895632'><span class="lit">'.'</span></div>
                    </div>
                </div>
                 
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("L.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("L")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657237906672'><span class="lit">X.find_end(' ', 0)</span></div> <div class="leaf box" id='94657238009440'><span class="lit">X.find_end('[A-Z]', 1)</span></div>
                    </div>
                </div>
                 <div class="leaf box" id='94657237581536'><span class="lit">'.'</span></div>
                    </div>
                </div>
                
                    </div>
                </div>
                    
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F.L.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="union">
                    <div class="box">
                        <span class="op">∪</span>
                        <div class="union-label">StringConst("First Last") → StringConst("F.L")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F.L")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="union">
                    <div class="box">
                        <span class="op">∪</span>
                        <div class="union-label">StringConst("First Last") → StringConst("F")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657237463776'><span class="lit">0</span></div> <div class="leaf box" id='94657237995104'><span class="lit">1</span></div>
                    </div>
                </div>
                
                    </div>
                </div> 
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst(".L")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657237919120'><span class="lit">'.'</span></div> 
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("L")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657237941776'><span class="lit">X.find_end(' ', 0)</span></div> <div class="leaf box" id='94657237457408'><span class="lit">X.find_end('[A-Z]', 1)</span></div>
                    </div>
                </div>
                
                    </div>
                </div>
                
                    </div>
                </div>
                  
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F.L")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Concat</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F.")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="union">
                    <div class="box">
                        <span class="op">∪</span>
                        <div class="union-label">StringConst("First Last") → StringConst("F")</div>
                    </div>
                    <div class="join-children">
                        
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("F")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657237998400'><span class="lit">0</span></div> <div class="leaf box" id='94657237061248'><span class="lit">1</span></div>
                    </div>
                </div>
                
                    </div>
                </div> <div class="leaf box" id='94657237881520'><span class="lit">'.'</span></div>
                    </div>
                </div>
                 
                <div class="join">
                    <div class="box">
                        <span class="op">Slice</span>
                        <div class="join-label">StringConst("First Last") → StringConst("L")</div>
                    </div>
                    <div class="join-children">
                        <div class="leaf box" id='94657237996384'><span class="lit">X.find_end(' ', 0)</span></div> <div class="leaf box" id='94657237486480'><span class="lit">X.find_end('[A-Z]', 1)</span></div>
                    </div>
                </div>
                
                    </div>
                </div>
                
                    </div>
                </div> <div class="leaf box" id='94657237893936'><span class="lit">'.'</span></div>
                    </div>
                </div>
                
                    </div>
                </div>
        </div>
    </body>
    <style>
body {
    width: 100vw;
    height: 100vh;
    user-select: none;
}
.svg-container {
    position: absolute;
    width: 100%;
    height: 100%;
}

svg {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
}

body {
    padding: 10px;
}
.vsa {
  font-family: monospace;
  font-size: 1.5em;
  max-width: 100vw;
  font-size: calc(1vw);
  position: relative;
}

.vsa *:not(.lit) {
  padding: 10px;
}

.union {
  align-items: center;
}

.join {
}

.join .op {
    font-weight: bold;
    text-decoration: underline;
}

.box {
    border: 1px solid black;
    text-align: center;
    position: absolute;
}

.op {
  margin-right: 5px;
}

.leaf {
  margin-left: 10px;
  margin-right: 10px;
}

.lit {
}
    </style>

    <script>
        window.root = document.querySelector('#root');
        window.vsas = () => allChildren(root);

        function allChildren(node) {
            function helper(node, acc) {
                for (let child of node.children) {
                    acc.push(child);
                    helper(child, acc);
                }
            }

            let acc = [node]
            helper(node, acc);
            return acc;
        }

        vsas().forEach(node => {
            node.onclick = () => {
            }
        });

        let svg_container = document.querySelector('svg');
        let nodes = new Map();
        let init_node = node => {
            nodes.set(node, {
                node: node,
                children: new Set(),
                parents: new Set(),
                from_lines: new Set(),
                to_lines: new Set()
            });
        };
        let If = cond => { return { then: eff => cond && eff() } };
        let ensure_init = node => If(nodes.get(node) === undefined).then(() => init_node(node));
        let add_child = (parent, child) => {
            ensure_init(parent); // probably redundant
            return nodes.get(parent).children.add(child);
        };
        let add_parent = (child, parent) => {
            ensure_init(child);
            nodes.get(child).parents.add(parent);
        };
        let add_edge = (parent, child, line) => {
            add_child(parent, child);
            add_parent(child, parent);
            nodes.get(parent).from_lines.add(line);
            nodes.get(child).to_lines.add(line);
        };
        let move_node = (node, x, y) => {
            node.style.left = x + 'px';
            node.style.top = y + 'px';
            let node_info = nodes.get(node);
            let from_lines = node_info.from_lines;
            let to_lines = node_info.to_lines;
            for (let line of from_lines) {
                line.setAttribute('x1', node.offsetLeft + node.offsetWidth / 2);
                line.setAttribute('y1', node.offsetTop + node.offsetHeight);
            }
            for (let line of to_lines) {
                line.setAttribute('x2', node.offsetLeft + node.offsetWidth / 2);
                line.setAttribute('y2', node.offsetTop);
            }
        };
        let root_vsa = null;
        function find_parent_box(node) {
            function helper(node) {
                if (node.classList === undefined) return null;

                if (node.classList.contains('union') || node.classList.contains('join')) {
                    return node.children[0];
                } else {
                    return helper(node.parentNode);
                }
            }

            return helper(node.parentNode.parentNode);
        }
        for (let node of document.querySelectorAll('.box')) {
            let box = find_parent_box(node);
            if (box !== null) {
                let child = node;
                let line = svg_container.appendChild(document.createElementNS('http://www.w3.org/2000/svg', 'line'));
                line.setAttribute('x1', box.offsetLeft + box.offsetWidth / 2);
                line.setAttribute('y1', box.offsetTop + box.offsetHeight);
                line.setAttribute('x2', child.offsetLeft + child.offsetWidth / 2);
                line.setAttribute('y2', child.offsetTop);
                line.setAttribute('stroke', 'black');

                add_edge(box, child, line);
            } else {
                // root
                root_vsa = node;
                init_node(node);
            }
        }

        for (let [node, info] of nodes.entries()) {
            let from_lines = Array.from(info.from_lines);
            let to_lines = Array.from(info.to_lines);

            // make node draggable
            node.onmousedown = (e) => {
                let x = e.clientX;
                let y = e.clientY;
                let move = (e) => {
                    x = e.clientX;
                    y = e.clientY;
                    move_node(node, x - node.offsetWidth / 2, y - node.offsetHeight / 2);
                };
                let up = (e) => {
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('mouseup', up);
                };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', up);
            };
        }

        const branch_height = 200;
        function place(node, x, y) {
            move_node(node, x, y);
            let center_x = x + node.offsetWidth / 2;

            let children = nodes.get(node).children;
            let child_widths = [...children].map(c => c.offsetWidth * 1.25)
            let total_branch_width = child_widths.reduce((x, y) => x + y, 0);
            let child_x = center_x - total_branch_width / children.size;
            let child_y = y + branch_height;
            console.log(children, total_branch_width, x, y, child_x, child_y);
            for (let child of children) {
                let branch_width = child.offsetWidth * 1.5;
                place(child, child_x, child_y);
                child_x += branch_width;
            }
        }

        place(root_vsa, window.innerWidth / 2 - 200, 100);
    </script>
</html>