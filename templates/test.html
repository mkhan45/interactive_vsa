<html>
    <head>
        <title> VSA </title>
    </head>
    <body>
        <div class="svg-container"><svg></svg></div>
        <div class="vsa" id="root">
            {{ vsa_html|safe }}
        </div>
    </body>
    <style>
body {
    width: 100vw;
    height: 100vh;
    user-select: none;
}
.svg-container {
    position: absolute;
    width: 100%;
    height: 100%;
}

svg {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
}

body {
    padding: 10px;
}
.vsa {
  font-family: monospace;
  font-size: 1.5em;
  max-width: 100vw;
  font-size: calc(1vw);
  position: relative;
}

.vsa *:not(.lit) {
  padding: 10px;
}

.union {
  align-items: center;
}

.join {
}

.join .op {
    font-weight: bold;
    text-decoration: underline;
}

.box {
    border: 1px solid black;
    text-align: center;
    position: absolute;
}

.op {
  margin-right: 5px;
}

.leaf {
  margin-left: 10px;
  margin-right: 10px;
}

.lit {
}
    </style>

    <script>
        window.root = document.querySelector('#root');
        window.vsas = () => allChildren(root);

        function allChildren(node) {
            function helper(node, acc) {
                for (let child of node.children) {
                    acc.push(child);
                    helper(child, acc);
                }
            }

            let acc = [node]
            helper(node, acc);
            return acc;
        }

        vsas().forEach(node => {
            node.onclick = () => {
            }
        });

        let svg_container = document.querySelector('svg');
        let child_info_map = new Map();
        let child_to_info = child_info_map.get.bind(child_info_map);
        for (let child of document.querySelectorAll('.box')) {
            let grandparent = child.parentNode.parentNode;
            let box = grandparent.children[0];
            if (!box.classList.contains('box')) continue;

            let line = svg_container.appendChild(document.createElementNS('http://www.w3.org/2000/svg', 'line'));
            line.setAttribute('x1', box.offsetLeft + box.offsetWidth / 2);
            line.setAttribute('y1', box.offsetTop + box.offsetHeight);
            line.setAttribute('x2', child.offsetLeft + child.offsetWidth / 2);
            line.setAttribute('y2', child.offsetTop);
            line.setAttribute('stroke', 'black');

            child_info_map.set(child, {line, box, child});
        }

        for (let child of document.querySelectorAll('.box')) {
            // make child draggable
            // this is all copilot
            child.addEventListener('mousedown', function(evt) {
                var mousemove = function(evt) {
                    child.style.left = (evt.pageX - child.offsetWidth / 2) + 'px';
                    child.style.top = (evt.pageY - child.offsetHeight / 2) + 'px';

                    // TODO: fix how lines work
                    // keep a map of from-lines and to-lines
                    // update each line accordingly
                    let child_info = child_to_info(child);
                    if (child_info !== undefined) {
                        let {line, box, _child} = child_info;
                        line.setAttribute('x1', box.offsetLeft + box.offsetWidth / 2);
                        line.setAttribute('y1', box.offsetTop + box.offsetHeight);
                        line.setAttribute('x2', child.offsetLeft + child.offsetWidth / 2);
                        line.setAttribute('y2', child.offsetTop);
                    }
                };
                var mouseup = function() {
                    document.removeEventListener('mousemove', mousemove);
                    document.removeEventListener('mouseup', mouseup);
                };
                document.addEventListener('mousemove', mousemove);
                document.addEventListener('mouseup', mouseup);
            });
        }
    </script>
</html>
